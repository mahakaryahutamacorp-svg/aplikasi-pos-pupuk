<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV. Maju Bersama - Sistem Kasir POS</title>
    <script src="./lib/tailwind.js"></script>
    <script defer src="./lib/alpine.js"></script>
    <script src="./lib/Chart.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            width: 100%;
        }

        .input-field:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .sidebar-active {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2) 0%, transparent 100%);
            border-left: 4px solid #10b981;
            color: #34d399 !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
    </style>
</head>

<body class="text-white" x-data="posApp()" x-init="init()" x-cloak>

    <!-- LOGIN SCREEN -->
    <div x-show="!isLoggedIn"
        class="fixed inset-0 bg-gradient-to-br from-emerald-600 to-emerald-800 flex items-center justify-center z-[9999]">
        <div class="card max-w-sm w-full mx-4 text-center">
            <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl font-bold text-emerald-600">MB</span>
            </div>
            <h1 class="text-2xl font-bold mb-2">CV. Maju Bersama</h1>
            <p class="text-sm text-slate-300 mb-6">Toko Pupuk & Pestisida</p>
            <input type="password" x-model="pinInput" @keyup.enter="checkPin()" maxlength="4" placeholder="Masukkan PIN"
                class="input-field text-center text-2xl tracking-widest mb-4" title="PIN 4 digit">
            <button @click="checkPin()" class="btn-primary w-full">ğŸ”“ Login</button>
            <p x-show="pinError" class="text-red-400 text-sm mt-3">âŒ PIN salah!</p>
            <p class="text-xs text-slate-400 mt-4">Default PIN: 2103</p>
        </div>
    </div>

    <!-- HEADER -->
    <header x-show="isLoggedIn" class="bg-gradient-to-r from-emerald-600 to-emerald-800 shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center">
                    <span class="text-2xl font-bold text-emerald-600">MB</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold">CV. Maju Bersama</h1>
                    <p class="text-xs opacity-80">Toko Pupuk & Pestisida</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button @click="showCalc = true" class="p-2 hover:bg-emerald-700 rounded-lg"
                    title="Kalkulator">ğŸ§®</button>
                <span class="text-sm opacity-80" x-text="currentDateTime"></span>
            </div>
        </div>
    </header>

    <!-- CALCULATOR MODAL -->
    <div x-show="showCalc" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="card max-w-xs w-full">
            <div class="flex justify-between mb-4">
                <h3 class="font-bold">ğŸ§® Kalkulator</h3><button @click="showCalc=false" class="text-xl">Ã—</button>
            </div>
            <input type="text" x-model="calcDisplay" class="input-field text-right text-xl font-mono mb-3" readonly
                title="Hasil">
            <div class="grid grid-cols-4 gap-2">
                <template x-for="b in ['7','8','9','Ã·','4','5','6','Ã—','1','2','3','-','C','0','=','+']">
                    <button @click="calcInput(b)" class="p-3 rounded-lg font-bold"
                        :class="b==='=' ? 'bg-emerald-600' : ['Ã·','Ã—','-','+'].includes(b) ? 'bg-orange-500' : b==='C' ? 'bg-red-500' : 'bg-slate-600'"
                        x-text="b"></button>
                </template>
            </div>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div x-show="isLoggedIn" class="flex h-[calc(100vh-80px)]">
        <!-- SIDEBAR -->
        <aside class="w-56 bg-slate-900 border-r border-slate-700 flex-shrink-0 overflow-y-auto">
            <nav class="p-3 space-y-1 text-sm">
                <button @click="page='dashboard'" :class="{'sidebar-active':page==='dashboard'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ 
                    Dashboard</button>
                <button @click="page='kasir'" :class="{'sidebar-active':page==='kasir'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ›’
                    Kasir</button>
                <button @click="page='stok'" :class="{'sidebar-active':page==='stok'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ“¦ Stok
                    Barang</button>
                <button @click="page='pelanggan'" :class="{'sidebar-active':page==='pelanggan'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ‘¥
                    Pelanggan</button>
                <button @click="page='supplier'" :class="{'sidebar-active':page==='supplier'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ­
                    Supplier</button>
                <button @click="page='pembelian'" :class="{'sidebar-active':page==='pembelian'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ“¥
                    Pembelian/PO</button>
                <div class="border-t border-slate-700 my-2"></div>
                <button @click="page='bukubesar'" :class="{'sidebar-active':page==='bukubesar'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ“’ Buku
                    Besar</button>
                <button @click="page='laporan'" :class="{'sidebar-active':page==='laporan'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">ğŸ“Š
                    Laporan</button>
                <button @click="page='pengaturan'" :class="{'sidebar-active':page==='pengaturan'}"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-slate-800">âš™ï¸
                    Pengaturan</button>
                <div class="border-t border-slate-700 my-2"></div>
                <button @click="logout()"
                    class="w-full px-3 py-2 rounded-lg text-left flex items-center gap-2 hover:bg-red-900/30 text-red-400">ğŸšª
                    Logout</button>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-6">

            <!-- DASHBOARD -->
            <div x-show="page==='dashboard'" class="space-y-6">
                <h2 class="text-2xl font-bold">ğŸ  Dashboard</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="card bg-gradient-to-br from-emerald-500 to-emerald-600">
                        <p class="text-sm opacity-90">Total Produk</p>
                        <p class="text-2xl font-bold mt-1" x-text="products.length"></p>
                    </div>
                    <div class="card bg-gradient-to-br from-blue-500 to-blue-600">
                        <p class="text-sm opacity-90">Transaksi Hari Ini</p>
                        <p class="text-2xl font-bold mt-1" x-text="getTodayTx()"></p>
                    </div>
                    <div class="card bg-gradient-to-br from-amber-500 to-amber-600">
                        <p class="text-sm opacity-90">Piutang Pelanggan</p>
                        <p class="text-2xl font-bold mt-1">Rp <span x-text="fmt(getTotalPiutang())"></span></p>
                    </div>
                    <div class="card bg-gradient-to-br from-red-500 to-red-600">
                        <p class="text-sm opacity-90">Hutang ke Supplier</p>
                        <p class="text-2xl font-bold mt-1">Rp <span x-text="fmt(getTotalHutang())"></span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button @click="page='kasir'" class="card hover:bg-slate-700 text-center py-6"><span
                            class="text-3xl">ğŸ›’</span>
                        <p class="font-bold mt-2">Kasir</p>
                    </button>
                    <button @click="page='stok';showAddProd=true" class="card hover:bg-slate-700 text-center py-6"><span
                            class="text-3xl">â•</span>
                        <p class="font-bold mt-2">Tambah Produk</p>
                    </button>
                    <button @click="page='pembelian'" class="card hover:bg-slate-700 text-center py-6"><span
                            class="text-3xl">ğŸ“¥</span>
                        <p class="font-bold mt-2">Pembelian</p>
                    </button>
                    <button @click="page='bukubesar'" class="card hover:bg-slate-700 text-center py-6"><span
                            class="text-3xl">ğŸ“’</span>
                        <p class="font-bold mt-2">Buku Besar</p>
                    </button>
                </div>
            </div>

            <!-- KASIR -->
            <div x-show="page==='kasir'" class="space-y-4">
                <h2 class="text-2xl font-bold">ğŸ›’ Kasir</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card">
                        <input type="text" x-model="search" placeholder="ğŸ” Cari produk..." class="input-field mb-4"
                            title="Cari">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-[55vh] overflow-y-auto">
                            <template x-for="p in filteredProds()" :key="p.id">
                                <div class="card p-3 cursor-pointer hover:border-emerald-500 border-2 border-transparent"
                                    @click="selectProd(p)">
                                    <p class="font-bold text-sm" x-text="p.name"></p>
                                    <p class="text-xs text-slate-400 mt-1">Stok: <span x-text="p.stock"></span> <span
                                            x-text="p.unit"></span></p>
                                    <div class="mt-2 text-xs space-y-1">
                                        <p class="text-emerald-400">Ecer: Rp <span x-text="fmt(p.priceEcer)"></span></p>
                                        <p class="text-amber-400">Grosir: Rp <span x-text="fmt(p.priceGrosir)"></span>
                                        </p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="card flex flex-col">
                        <h3 class="font-bold mb-4">ğŸ›’ Keranjang</h3>
                        <div class="flex-1 overflow-y-auto space-y-2 mb-4 max-h-[40vh]">
                            <template x-if="cart.length===0">
                                <p class="text-center text-slate-500 py-10">Kosong</p>
                            </template>
                            <template x-for="(item,idx) in cart" :key="idx">
                                <div class="p-2 bg-slate-700 rounded">
                                    <div class="flex justify-between">
                                        <p class="font-medium text-sm" x-text="item.name"></p><button
                                            @click="cart.splice(idx,1)" class="text-red-400">Ã—</button>
                                    </div>
                                    <div class="flex justify-between items-center mt-2">
                                        <div class="flex items-center gap-1">
                                            <button @click="item.qty>1?item.qty--:null"
                                                class="w-6 h-6 bg-slate-600 rounded">-</button>
                                            <span class="w-8 text-center" x-text="item.qty"></span>
                                            <button @click="item.qty++" class="w-6 h-6 bg-slate-600 rounded">+</button>
                                        </div>
                                        <select x-model="item.priceType" class="bg-slate-600 text-xs rounded px-2 py-1"
                                            title="Tipe harga"
                                            @change="item.price=item.priceType==='ecer'?item.priceEcer:item.priceGrosir">
                                            <option value="ecer">Ecer</option>
                                            <option value="grosir">Grosir</option>
                                        </select>
                                        <span class="text-emerald-400 font-bold">Rp <span
                                                x-text="fmt(item.price*item.qty)"></span></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="border-t border-slate-600 pt-4 space-y-3">
                            <div class="flex justify-between text-xl font-bold"><span>Total:</span><span
                                    class="text-emerald-400">Rp <span x-text="fmt(cartTotal())"></span></span></div>
                            <input type="text" x-model="txCustomer" placeholder="ğŸ‘¤ Nama Pelanggan"
                                class="input-field text-sm" title="Pelanggan">
                            <div class="grid grid-cols-2 gap-2">
                                <button @click="txType='cash'" :class="txType==='cash'?'bg-emerald-600':'bg-slate-700'"
                                    class="py-2 rounded-lg text-sm">ğŸ’µ Tunai</button>
                                <button @click="txType='debt'" :class="txType==='debt'?'bg-orange-500':'bg-slate-700'"
                                    class="py-2 rounded-lg text-sm">ğŸ“ Hutang</button>
                            </div>
                            <button @click="checkout()" :disabled="cart.length===0" class="btn-primary w-full py-3"
                                :class="{'opacity-50':cart.length===0}">âœ“ BAYAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STOK BARANG -->
            <div x-show="page==='stok'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">ğŸ“¦ Stok Barang</h2><button @click="showAddProd=true;resetProdForm()"
                        class="btn-primary">â• Tambah</button>
                </div>
                <div class="card">
                    <input type="text" x-model="search" placeholder="ğŸ” Cari..." class="input-field mb-4" title="Cari">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-slate-600 text-slate-400 text-left">
                                <tr>
                                    <th class="pb-2">Nama</th>
                                    <th class="pb-2">Jenis</th>
                                    <th class="pb-2">Stok</th>
                                    <th class="pb-2">Modal</th>
                                    <th class="pb-2">Ecer</th>
                                    <th class="pb-2">Grosir</th>
                                    <th class="pb-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="p in filteredProds()" :key="p.id">
                                    <tr class="border-b border-slate-700 hover:bg-slate-700">
                                        <td class="py-2" x-text="p.name"></td>
                                        <td class="py-2"><span class="px-2 py-1 rounded text-xs"
                                                :class="p.type==='pupuk'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'"
                                                x-text="p.type"></span></td>
                                        <td class="py-2" x-text="p.stock+' '+p.unit"></td>
                                        <td class="py-2">Rp <span x-text="fmt(p.priceModal)"></span></td>
                                        <td class="py-2 text-emerald-400">Rp <span x-text="fmt(p.priceEcer)"></span>
                                        </td>
                                        <td class="py-2 text-amber-400">Rp <span x-text="fmt(p.priceGrosir)"></span>
                                        </td>
                                        <td class="py-2"><button @click="editProd(p)"
                                                class="text-blue-400 mr-2">âœï¸</button><button @click="delProd(p.id)"
                                                class="text-red-400">ğŸ—‘ï¸</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADD/EDIT PRODUCT MODAL -->
            <div x-show="showAddProd" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-md w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold" x-text="editingProd?'Edit Produk':'Tambah Produk'"></h3><button
                            @click="showAddProd=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" x-model="prodForm.name" placeholder="Nama Produk" class="input-field"
                            title="Nama">
                        <select x-model="prodForm.type" class="input-field" title="Jenis" aria-label="Jenis">
                            <option value="pupuk">Pupuk</option>
                            <option value="pestisida">Pestisida</option>
                        </select>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" x-model="prodForm.stock" placeholder="Stok Awal" class="input-field"
                                title="Stok">
                            <input type="text" x-model="prodForm.unit" placeholder="Satuan" class="input-field"
                                title="Satuan">
                        </div>
                        <input type="number" x-model="prodForm.priceModal" placeholder="Harga Modal" class="input-field"
                            title="Modal">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" x-model="prodForm.priceEcer" placeholder="Harga Ecer"
                                class="input-field" title="Ecer">
                            <input type="number" x-model="prodForm.priceGrosir" placeholder="Harga Grosir"
                                class="input-field" title="Grosir">
                        </div>
                        <button @click="saveProd()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- PELANGGAN -->
            <div x-show="page==='pelanggan'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">ğŸ‘¥ Pelanggan</h2><button @click="showAddCust=true;resetCustForm()"
                        class="btn-primary">â• Tambah</button>
                </div>
                <div class="card">
                    <input type="text" x-model="searchCust" placeholder="ğŸ” Cari..." class="input-field mb-4"
                        title="Cari">
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-600 text-slate-400 text-left">
                            <tr>
                                <th class="pb-2">Nama</th>
                                <th class="pb-2">Telepon</th>
                                <th class="pb-2">Alamat</th>
                                <th class="pb-2">Piutang</th>
                                <th class="pb-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="c in filteredCusts()" :key="c.id">
                                <tr class="border-b border-slate-700 hover:bg-slate-700">
                                    <td class="py-2" x-text="c.name"></td>
                                    <td class="py-2" x-text="c.phone||'-'"></td>
                                    <td class="py-2" x-text="c.address||'-'"></td>
                                    <td class="py-2" :class="c.debt>0?'text-red-400':'text-emerald-400'">Rp <span
                                            x-text="fmt(c.debt||0)"></span></td>
                                    <td class="py-2"><button x-show="c.debt>0" @click="payCustDebt(c)"
                                            class="text-emerald-400 mr-2">ğŸ’°</button><button @click="editCust(c)"
                                            class="text-blue-400 mr-2">âœï¸</button><button @click="delCust(c.id)"
                                            class="text-red-400">ğŸ—‘ï¸</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ADD/EDIT CUSTOMER MODAL -->
            <div x-show="showAddCust" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-md w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold" x-text="editingCust?'Edit Pelanggan':'Tambah Pelanggan'"></h3><button
                            @click="showAddCust=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" x-model="custForm.name" placeholder="Nama" class="input-field" title="Nama">
                        <input type="text" x-model="custForm.phone" placeholder="Telepon" class="input-field"
                            title="Telepon">
                        <input type="text" x-model="custForm.address" placeholder="Alamat" class="input-field"
                            title="Alamat">
                        <button @click="saveCust()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- SUPPLIER -->
            <div x-show="page==='supplier'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">ğŸ­ Supplier</h2><button @click="showAddSupp=true;resetSuppForm()"
                        class="btn-primary">â• Tambah</button>
                </div>
                <div class="card">
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-600 text-slate-400 text-left">
                            <tr>
                                <th class="pb-2">Nama</th>
                                <th class="pb-2">Telepon</th>
                                <th class="pb-2">Alamat</th>
                                <th class="pb-2">Hutang</th>
                                <th class="pb-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="s in suppliers" :key="s.id">
                                <tr class="border-b border-slate-700 hover:bg-slate-700">
                                    <td class="py-2" x-text="s.name"></td>
                                    <td class="py-2" x-text="s.phone||'-'"></td>
                                    <td class="py-2" x-text="s.address||'-'"></td>
                                    <td class="py-2 text-red-400">Rp <span x-text="fmt(s.debt||0)"></span></td>
                                    <td class="py-2"><button x-show="s.debt>0" @click="paySuppDebt(s)"
                                            class="text-emerald-400 mr-2">ğŸ’°</button><button @click="editSupp(s)"
                                            class="text-blue-400 mr-2">âœï¸</button><button @click="delSupp(s.id)"
                                            class="text-red-400">ğŸ—‘ï¸</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ADD/EDIT SUPPLIER MODAL -->
            <div x-show="showAddSupp" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-md w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold" x-text="editingSupp?'Edit Supplier':'Tambah Supplier'"></h3><button
                            @click="showAddSupp=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" x-model="suppForm.name" placeholder="Nama" class="input-field" title="Nama">
                        <input type="text" x-model="suppForm.phone" placeholder="Telepon" class="input-field"
                            title="Telepon">
                        <input type="text" x-model="suppForm.address" placeholder="Alamat" class="input-field"
                            title="Alamat">
                        <button @click="saveSupp()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- PEMBELIAN/PO -->
            <div x-show="page==='pembelian'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">ğŸ“¥ Pembelian / PO</h2><button @click="showAddPO=true;resetPOForm()"
                        class="btn-primary">â• Buat PO</button>
                </div>
                <div class="card">
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-600 text-slate-400 text-left">
                            <tr>
                                <th class="pb-2">Tanggal</th>
                                <th class="pb-2">Supplier</th>
                                <th class="pb-2">Total</th>
                                <th class="pb-2">Bayar</th>
                                <th class="pb-2">Tempo</th>
                                <th class="pb-2">Status</th>
                                <th class="pb-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="po in purchases" :key="po.id">
                                <tr class="border-b border-slate-700 hover:bg-slate-700">
                                    <td class="py-2" x-text="fmtDate(po.date)"></td>
                                    <td class="py-2" x-text="po.supplierName"></td>
                                    <td class="py-2">Rp <span x-text="fmt(po.total)"></span></td>
                                    <td class="py-2"><span class="px-2 py-1 rounded text-xs"
                                            :class="po.payMethod==='cash'?'bg-emerald-500/20 text-emerald-400':'bg-orange-500/20 text-orange-400'"
                                            x-text="po.payMethod==='cash'?'Tunai':'Tempo'"></span></td>
                                    <td class="py-2" x-text="po.dueDate?fmtDate(po.dueDate):'-'"></td>
                                    <td class="py-2"><span class="px-2 py-1 rounded text-xs"
                                            :class="po.status==='lunas'?'bg-emerald-500/20 text-emerald-400':po.status==='sebagian'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400'"
                                            x-text="po.status==='lunas'?'Lunas':po.status==='sebagian'?'Sebagian':'Belum Bayar'"></span>
                                    </td>
                                    <td class="py-2"><button x-show="po.status!=='lunas'" @click="payPO(po)"
                                            class="text-emerald-400 mr-2">ğŸ’°</button><button @click="delPO(po.id)"
                                            class="text-red-400">ğŸ—‘ï¸</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ADD PO MODAL -->
            <div x-show="showAddPO" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-md w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold">Buat PO Baru</h3><button @click="showAddPO=false"
                            class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <select x-model="poForm.supplierId" class="input-field" title="Supplier" aria-label="Supplier">
                            <option value="">Pilih Supplier</option><template x-for="s in suppliers">
                                <option :value="s.id" x-text="s.name"></option>
                            </template>
                        </select>
                        <input type="number" x-model="poForm.total" placeholder="Total Pembelian" class="input-field"
                            title="Total">
                        <select x-model="poForm.payMethod" class="input-field" title="Cara Bayar"
                            aria-label="Cara Bayar">
                            <option value="cash">Tunai</option>
                            <option value="tempo">Tempo</option>
                        </select>
                        <input x-show="poForm.payMethod==='tempo'" type="date" x-model="poForm.dueDate"
                            class="input-field" title="Jatuh Tempo">
                        <button @click="savePO()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- BUKU BESAR -->
            <div x-show="page==='bukubesar'" class="space-y-4">
                <div class="flex justify-between items-center flex-wrap gap-2">
                    <h2 class="text-2xl font-bold">ğŸ“’ Buku Besar</h2>
                    <div class="flex gap-2">
                        <button
                            @click="showAddLedger=true;ledgerForm={type:'piutang',entityType:'customer',entityId:'',amount:0,note:'',date:new Date().toISOString().split('T')[0]}"
                            class="btn-primary">â• Entri Manual</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card bg-gradient-to-br from-amber-500/20 to-amber-600/20 border-amber-500/30">
                        <h3 class="font-bold text-lg text-amber-400">ï¿½ Total Piutang (Pelanggan)</h3>
                        <p class="text-3xl font-bold mt-2">Rp <span x-text="fmt(getTotalPiutang())"></span></p>
                    </div>
                    <div class="card bg-gradient-to-br from-red-500/20 to-red-600/20 border-red-500/30">
                        <h3 class="font-bold text-lg text-red-400">ğŸ’¸ Total Hutang (Supplier)</h3>
                        <p class="text-3xl font-bold mt-2">Rp <span x-text="fmt(getTotalHutang())"></span></p>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-2 border-b border-slate-700 pb-2">
                    <button @click="ledgerTab='piutang'" :class="ledgerTab==='piutang'?'bg-amber-600':'bg-slate-700'"
                        class="px-4 py-2 rounded-lg text-sm">ğŸ“‹ Piutang Pelanggan</button>
                    <button @click="ledgerTab='hutang'" :class="ledgerTab==='hutang'?'bg-red-600':'bg-slate-700'"
                        class="px-4 py-2 rounded-lg text-sm">ğŸ“‹ Hutang Supplier</button>
                    <button @click="ledgerTab='riwayat'" :class="ledgerTab==='riwayat'?'bg-blue-600':'bg-slate-700'"
                        class="px-4 py-2 rounded-lg text-sm">ğŸ“œ Riwayat</button>
                </div>

                <!-- Tab: Piutang -->
                <div x-show="ledgerTab==='piutang'" class="card">
                    <h3 class="font-bold mb-4 text-amber-400">ğŸ“‹ Daftar Piutang Pelanggan</h3>
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-600 text-slate-400 text-left">
                            <tr>
                                <th class="pb-2">Pelanggan</th>
                                <th class="pb-2">Telepon</th>
                                <th class="pb-2 text-right">Piutang</th>
                                <th class="pb-2 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="c in customers.filter(x=>x.debt>0)" :key="c.id">
                                <tr class="border-b border-slate-700 hover:bg-slate-700">
                                    <td class="py-2" x-text="c.name"></td>
                                    <td class="py-2" x-text="c.phone||'-'"></td>
                                    <td class="py-2 text-right text-red-400 font-bold">Rp <span
                                            x-text="fmt(c.debt)"></span></td>
                                    <td class="py-2 text-center">
                                        <button @click="openPayModal('customer',c)" class="text-emerald-400 mr-1"
                                            title="Bayar">ğŸ’°</button>
                                        <button @click="editDebtManual('customer',c)" class="text-blue-400 mr-1"
                                            title="Edit">âœï¸</button>
                                        <button @click="viewLedgerHistory('customer',c.id)" class="text-slate-400"
                                            title="Riwayat">ğŸ“œ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <p x-show="customers.filter(x=>x.debt>0).length===0" class="text-center text-slate-500 py-4">Tidak
                        ada piutang</p>
                </div>

                <!-- Tab: Hutang -->
                <div x-show="ledgerTab==='hutang'" class="card">
                    <h3 class="font-bold mb-4 text-red-400">ğŸ“‹ Daftar Hutang ke Supplier</h3>
                    <table class="w-full text-sm">
                        <thead class="border-b border-slate-600 text-slate-400 text-left">
                            <tr>
                                <th class="pb-2">Supplier</th>
                                <th class="pb-2">Telepon</th>
                                <th class="pb-2 text-right">Hutang</th>
                                <th class="pb-2 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="s in suppliers.filter(x=>x.debt>0)" :key="s.id">
                                <tr class="border-b border-slate-700 hover:bg-slate-700">
                                    <td class="py-2" x-text="s.name"></td>
                                    <td class="py-2" x-text="s.phone||'-'"></td>
                                    <td class="py-2 text-right text-red-400 font-bold">Rp <span
                                            x-text="fmt(s.debt)"></span></td>
                                    <td class="py-2 text-center">
                                        <button @click="openPayModal('supplier',s)" class="text-emerald-400 mr-1"
                                            title="Bayar">ğŸ’°</button>
                                        <button @click="editDebtManual('supplier',s)" class="text-blue-400 mr-1"
                                            title="Edit">âœï¸</button>
                                        <button @click="viewLedgerHistory('supplier',s.id)" class="text-slate-400"
                                            title="Riwayat">ï¿½</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <p x-show="suppliers.filter(x=>x.debt>0).length===0" class="text-center text-slate-500 py-4">Tidak
                        ada hutang</p>
                </div>

                <!-- Tab: Riwayat -->
                <div x-show="ledgerTab==='riwayat'" class="card">
                    <h3 class="font-bold mb-4">ğŸ“œ Riwayat Transaksi Hutang/Piutang</h3>
                    <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-slate-600 text-slate-400 text-left sticky top-0 bg-slate-800">
                                <tr>
                                    <th class="pb-2">Tanggal</th>
                                    <th class="pb-2">Tipe</th>
                                    <th class="pb-2">Nama</th>
                                    <th class="pb-2">Keterangan</th>
                                    <th class="pb-2 text-right">Jumlah</th>
                                    <th class="pb-2">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="l in ledgerEntries.slice().reverse()" :key="l.id">
                                    <tr class="border-b border-slate-700 hover:bg-slate-700">
                                        <td class="py-2" x-text="fmtDate(l.date)"></td>
                                        <td class="py-2"><span class="px-2 py-1 rounded text-xs"
                                                :class="l.type==='piutang'?'bg-amber-500/20 text-amber-400':l.type==='hutang'?'bg-red-500/20 text-red-400':'bg-emerald-500/20 text-emerald-400'"
                                                x-text="l.type==='piutang'?'Piutang':l.type==='hutang'?'Hutang':'Bayar'"></span>
                                        </td>
                                        <td class="py-2" x-text="l.entityName"></td>
                                        <td class="py-2 text-slate-400 text-xs" x-text="l.note||'-'"></td>
                                        <td class="py-2 text-right font-bold"
                                            :class="l.type==='bayar'?'text-emerald-400':'text-red-400'">
                                            <span x-text="l.type==='bayar'?'-':'+'"></span>Rp <span
                                                x-text="fmt(l.amount)"></span>
                                        </td>
                                        <td class="py-2">
                                            <button @click="editLedgerEntry(l)" class="text-blue-400 mr-1">âœï¸</button>
                                            <button @click="delLedgerEntry(l.id)" class="text-red-400">ğŸ—‘ï¸</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <p x-show="ledgerEntries.length===0" class="text-center text-slate-500 py-4">Belum ada riwayat</p>
                </div>
            </div>

            <!-- ADD LEDGER ENTRY MODAL -->
            <div x-show="showAddLedger" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-md w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold" x-text="editingLedger?'Edit Entri':'Tambah Entri Manual'"></h3>
                        <button @click="showAddLedger=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <select x-model="ledgerForm.type" class="input-field" title="Tipe" aria-label="Tipe">
                            <option value="piutang">â• Tambah Piutang (Pelanggan Hutang)</option>
                            <option value="hutang">â• Tambah Hutang (Kita Hutang ke Supplier)</option>
                            <option value="bayar">ğŸ’° Pembayaran</option>
                        </select>
                        <select x-model="ledgerForm.entityType" @change="ledgerForm.entityId=''" class="input-field"
                            title="Tipe Entity" aria-label="Entity Type">
                            <option value="customer">Pelanggan</option>
                            <option value="supplier">Supplier</option>
                        </select>
                        <select x-model="ledgerForm.entityId" class="input-field" title="Pilih" aria-label="Entity">
                            <option value="">-- Pilih --</option>
                            <template x-if="ledgerForm.entityType==='customer'">
                                <template x-for="c in customers">
                                    <option :value="c.id" x-text="c.name"></option>
                                </template>
                            </template>
                            <template x-if="ledgerForm.entityType==='supplier'">
                                <template x-for="s in suppliers">
                                    <option :value="s.id" x-text="s.name"></option>
                                </template>
                            </template>
                        </select>
                        <input type="number" x-model="ledgerForm.amount" placeholder="Jumlah (Rp)" class="input-field"
                            title="Jumlah">
                        <input type="date" x-model="ledgerForm.date" class="input-field" title="Tanggal">
                        <input type="text" x-model="ledgerForm.note" placeholder="Keterangan (opsional)"
                            class="input-field" title="Keterangan">
                        <button @click="saveLedgerEntry()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- PAYMENT MODAL -->
            <div x-show="showPayModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-sm w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold">ğŸ’° Pembayaran</h3>
                        <button @click="showPayModal=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <p class="text-slate-400">Nama: <span class="text-white font-bold"
                                x-text="payModalData.name"></span></p>
                        <p class="text-slate-400">Sisa: <span class="text-red-400 font-bold">Rp <span
                                    x-text="fmt(payModalData.debt)"></span></span></p>
                        <input type="number" x-model="payModalData.amount" placeholder="Jumlah Bayar"
                            class="input-field" title="Jumlah">
                        <input type="text" x-model="payModalData.note" placeholder="Keterangan" class="input-field"
                            title="Keterangan">
                        <div class="grid grid-cols-2 gap-2">
                            <button @click="payModalData.amount=payModalData.debt"
                                class="btn-secondary text-sm">Lunas</button>
                            <button @click="processPayment()" class="btn-primary">ï¿½ Bayar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDIT DEBT MODAL -->
            <div x-show="showEditDebt" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="card max-w-sm w-full">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold">âœï¸ Edit Saldo</h3>
                        <button @click="showEditDebt=false" class="text-xl">Ã—</button>
                    </div>
                    <div class="space-y-3">
                        <p class="text-slate-400">Nama: <span class="text-white font-bold"
                                x-text="editDebtData.name"></span></p>
                        <p class="text-slate-400">Saldo Saat Ini: <span class="text-red-400 font-bold">Rp <span
                                    x-text="fmt(editDebtData.currentDebt)"></span></span></p>
                        <input type="number" x-model="editDebtData.newDebt" placeholder="Saldo Baru" class="input-field"
                            title="Saldo Baru">
                        <input type="text" x-model="editDebtData.note" placeholder="Alasan perubahan"
                            class="input-field" title="Alasan">
                        <button @click="saveEditDebt()" class="btn-primary w-full">ğŸ’¾ Simpan</button>
                    </div>
                </div>
            </div>

            <!-- LAPORAN -->
            <div x-show="page==='laporan'" class="space-y-4">
                <h2 class="text-2xl font-bold">ğŸ“Š Laporan</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card">
                        <p class="text-sm text-slate-400">Total Penjualan</p>
                        <p class="text-2xl font-bold text-emerald-400 mt-2">Rp <span
                                x-text="fmt(getTotalSales())"></span></p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-slate-400">Total Transaksi</p>
                        <p class="text-2xl font-bold mt-2" x-text="transactions.length"></p>
                    </div>
                    <div class="card">
                        <p class="text-sm text-slate-400">Total Pembelian</p>
                        <p class="text-2xl font-bold text-red-400 mt-2">Rp <span
                                x-text="fmt(getTotalPurchases())"></span></p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4">Riwayat Transaksi</h3>
                    <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-slate-600 text-slate-400 text-left sticky top-0 bg-slate-800">
                                <tr>
                                    <th class="pb-2">Tanggal</th>
                                    <th class="pb-2">Pelanggan</th>
                                    <th class="pb-2">Tipe</th>
                                    <th class="pb-2 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="t in transactions.slice().reverse()" :key="t.id">
                                    <tr class="border-b border-slate-700">
                                        <td class="py-2" x-text="fmtDate(t.date)"></td>
                                        <td class="py-2" x-text="t.customerName||'Umum'"></td>
                                        <td class="py-2"><span
                                                :class="t.payType==='cash'?'bg-emerald-500/20 text-emerald-400':'bg-orange-500/20 text-orange-400'"
                                                class="px-2 py-1 rounded text-xs"
                                                x-text="t.payType==='cash'?'Tunai':'Hutang'"></span></td>
                                        <td class="py-2 text-right font-bold text-emerald-400">Rp <span
                                                x-text="fmt(t.total)"></span></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PENGATURAN -->
            <div x-show="page==='pengaturan'" class="space-y-4">
                <h2 class="text-2xl font-bold">âš™ï¸ Pengaturan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ’¾ Backup & Restore</h3>
                        <div class="space-y-3"><button @click="exportData()" class="btn-primary w-full">ğŸ“¥ Download
                                Backup</button><label class="btn-secondary w-full block text-center cursor-pointer">ğŸ“¤
                                Restore<input type="file" @change="importData($event)" accept=".json"
                                    class="hidden"></label></div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ” Ganti PIN</h3>
                        <div class="space-y-3"><input type="password" x-model="newPin" placeholder="PIN Baru (4 digit)"
                                maxlength="4" class="input-field" title="PIN Baru"><button @click="changePin()"
                                class="btn-primary w-full">ğŸ’¾ Simpan PIN</button></div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">ğŸ—‘ï¸ Reset Data</h3>
                        <p class="text-sm text-slate-400 mb-4">Hapus semua data.</p><button @click="resetAll()"
                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg w-full">âš ï¸ Reset</button>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">â„¹ï¸ Info</h3>
                        <p class="text-sm">CV. Maju Bersama POS v2.0</p>
                        <p class="text-xs text-slate-400 mt-2">Produk: <span x-text="products.length"></span> |
                            Transaksi: <span x-text="transactions.length"></span></p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- TOAST -->
    <div x-show="toast.show" x-transition class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50"
        :class="toast.type==='success'?'bg-emerald-600':toast.type==='error'?'bg-red-600':'bg-blue-600'">
        <p x-text="toast.message"></p>
    </div>

    <script>
        function posApp() {
            return {
                isLoggedIn: false, pinInput: '', pinError: false, pin: '2103', page: 'dashboard', search: '', searchCust: '', currentDateTime: '',
                products: [], customers: [], suppliers: [], transactions: [], purchases: [], cart: [], ledgerEntries: [],
                showAddProd: false, showAddCust: false, showAddSupp: false, showAddPO: false, showCalc: false,
                showAddLedger: false, showPayModal: false, showEditDebt: false, ledgerTab: 'piutang',
                editingProd: null, editingCust: null, editingSupp: null, editingLedger: null,
                prodForm: { name: '', type: 'pupuk', stock: 0, unit: 'kg', priceModal: 0, priceEcer: 0, priceGrosir: 0 },
                custForm: { name: '', phone: '', address: '' },
                suppForm: { name: '', phone: '', address: '' },
                poForm: { supplierId: '', total: 0, payMethod: 'cash', dueDate: '' },
                ledgerForm: { type: 'piutang', entityType: 'customer', entityId: '', amount: 0, note: '', date: '' },
                payModalData: { type: '', entity: null, name: '', debt: 0, amount: 0, note: '' },
                editDebtData: { type: '', entity: null, name: '', currentDebt: 0, newDebt: 0, note: '' },
                txCustomer: '', txType: 'cash', calcDisplay: '', newPin: '',
                toast: { show: false, message: '', type: 'success' },

                init() { this.loadFromAPI(); this.updateTime(); setInterval(() => this.updateTime(), 1000); },
                updateTime() { const d = new Date(); this.currentDateTime = d.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); },
                async loadFromAPI() {
                    try {
                        const [prods, custs, supps, txs, pos, ledger] = await Promise.all([
                            fetch('/api/products').then(r => r.json()),
                            fetch('/api/customers').then(r => r.json()),
                            fetch('/api/suppliers').then(r => r.json()),
                            fetch('/api/transactions').then(r => r.json()),
                            fetch('/api/purchases').then(r => r.json()),
                            fetch('/api/ledger').then(r => r.json())
                        ]);
                        this.products = prods; this.customers = custs; this.suppliers = supps;
                        this.transactions = txs; this.purchases = pos; this.ledgerEntries = ledger;
                    } catch (e) { console.error('Load error:', e); this.showToast('Gagal memuat data', 'error'); }
                },
                load() { this.loadFromAPI(); },
                save() { /* Now handled per-operation via API */ },
                fmt(n) { return new Intl.NumberFormat('id-ID').format(n || 0); },
                fmtDate(d) { return new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }); },
                showToast(m, t = 'success') { this.toast = { show: true, message: m, type: t }; setTimeout(() => this.toast.show = false, 3000); },
                async checkPin() {
                    try {
                        const res = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pin: this.pinInput }) });
                        if (res.ok) { this.isLoggedIn = true; this.pinError = false; }
                        else { this.pinError = true; }
                    } catch (e) { this.pinError = true; }
                },
                logout() { this.isLoggedIn = false; this.pinInput = ''; },
                async changePin() { if (this.newPin.length === 4) { await fetch('/api/auth/change-pin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ newPin: this.newPin }) }); this.newPin = ''; this.showToast('PIN berhasil diganti'); } else { this.showToast('PIN harus 4 digit', 'error'); } },

                filteredProds() { return this.products.filter(p => p.name.toLowerCase().includes(this.search.toLowerCase())); },
                resetProdForm() { this.prodForm = { name: '', type: 'pupuk', stock: 0, unit: 'kg', priceModal: 0, priceEcer: 0, priceGrosir: 0 }; this.editingProd = null; },
                async saveProd() { if (!this.prodForm.name) { this.showToast('Nama harus diisi', 'error'); return; } const data = { ...this.prodForm, stock: Number(this.prodForm.stock), priceModal: Number(this.prodForm.priceModal), priceEcer: Number(this.prodForm.priceEcer), priceGrosir: Number(this.prodForm.priceGrosir) }; if (this.editingProd) { await fetch('/api/products/' + this.editingProd.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); } else { await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); } await this.loadFromAPI(); this.showAddProd = false; this.resetProdForm(); this.showToast('Produk disimpan'); },
                editProd(p) { this.editingProd = p; this.prodForm = { ...p }; this.showAddProd = true; },
                async delProd(id) { if (confirm('Hapus produk?')) { await fetch('/api/products/' + id, { method: 'DELETE' }); await this.loadFromAPI(); this.showToast('Produk dihapus'); } },

                filteredCusts() { return this.customers.filter(c => c.name.toLowerCase().includes(this.searchCust.toLowerCase())); },
                resetCustForm() { this.custForm = { name: '', phone: '', address: '' }; this.editingCust = null; },
                async saveCust() { if (!this.custForm.name) { this.showToast('Nama harus diisi', 'error'); return; } if (this.editingCust) { await fetch('/api/customers/' + this.editingCust.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.custForm, debt: this.editingCust.debt || 0 }) }); } else { await fetch('/api/customers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.custForm, debt: 0 }) }); } await this.loadFromAPI(); this.showAddCust = false; this.resetCustForm(); this.showToast('Pelanggan disimpan'); },
                editCust(c) { this.editingCust = c; this.custForm = { name: c.name, phone: c.phone, address: c.address }; this.showAddCust = true; },
                async delCust(id) { if (confirm('Hapus pelanggan?')) { await fetch('/api/customers/' + id, { method: 'DELETE' }); await this.loadFromAPI(); this.showToast('Pelanggan dihapus'); } },
                async payCustDebt(c) { const a = prompt('Jumlah bayar:', c.debt); if (a && !isNaN(a)) { const newDebt = Math.max(0, c.debt - Number(a)); await fetch('/api/customers/' + c.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: c.name, phone: c.phone, address: c.address, debt: newDebt }) }); await this.loadFromAPI(); this.showToast('Pembayaran berhasil'); } },

                resetSuppForm() { this.suppForm = { name: '', phone: '', address: '' }; this.editingSupp = null; },
                async saveSupp() { if (!this.suppForm.name) { this.showToast('Nama harus diisi', 'error'); return; } if (this.editingSupp) { await fetch('/api/suppliers/' + this.editingSupp.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.suppForm, debt: this.editingSupp.debt || 0 }) }); } else { await fetch('/api/suppliers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.suppForm, debt: 0 }) }); } await this.loadFromAPI(); this.showAddSupp = false; this.resetSuppForm(); this.showToast('Supplier disimpan'); },
                editSupp(s) { this.editingSupp = s; this.suppForm = { name: s.name, phone: s.phone, address: s.address }; this.showAddSupp = true; },
                async delSupp(id) { if (confirm('Hapus supplier?')) { await fetch('/api/suppliers/' + id, { method: 'DELETE' }); await this.loadFromAPI(); this.showToast('Supplier dihapus'); } },
                async paySuppDebt(s) { const a = prompt('Jumlah bayar:', s.debt); if (a && !isNaN(a)) { const newDebt = Math.max(0, s.debt - Number(a)); await fetch('/api/suppliers/' + s.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: s.name, phone: s.phone, address: s.address, debt: newDebt }) }); await this.loadFromAPI(); this.showToast('Pembayaran berhasil'); } },

                resetPOForm() { this.poForm = { supplierId: '', total: 0, payMethod: 'cash', dueDate: '' }; },
                async savePO() { if (!this.poForm.supplierId || !this.poForm.total) { this.showToast('Lengkapi data', 'error'); return; } const supp = this.suppliers.find(s => s.id == this.poForm.supplierId); const po = { date: new Date().toISOString(), supplierId: Number(this.poForm.supplierId), supplierName: supp ? supp.name : '', total: Number(this.poForm.total), payMethod: this.poForm.payMethod, dueDate: this.poForm.dueDate || null, paid: 0, status: this.poForm.payMethod === 'cash' ? 'lunas' : 'belum' }; await fetch('/api/purchases', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(po) }); if (this.poForm.payMethod === 'tempo' && supp) { await fetch('/api/suppliers/' + supp.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: supp.name, phone: supp.phone, address: supp.address, debt: (supp.debt || 0) + po.total }) }); } await this.loadFromAPI(); this.showAddPO = false; this.resetPOForm(); this.showToast('PO disimpan'); },
                async payPO(po) { const a = prompt('Jumlah bayar:', po.total - po.paid); if (a && !isNaN(a)) { const newPaid = Math.min(po.paid + Number(a), po.total); const newStatus = newPaid >= po.total ? 'lunas' : newPaid > 0 ? 'sebagian' : 'belum'; await fetch('/api/purchases/' + po.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ paid: newPaid, status: newStatus }) }); const supp = this.suppliers.find(s => s.id == po.supplierId); if (supp) { await fetch('/api/suppliers/' + supp.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: supp.name, phone: supp.phone, address: supp.address, debt: Math.max(0, supp.debt - Number(a)) }) }); } await this.loadFromAPI(); this.showToast('Pembayaran PO berhasil'); } },
                async delPO(id) { if (confirm('Hapus PO?')) { await fetch('/api/purchases/' + id, { method: 'DELETE' }); await this.loadFromAPI(); this.showToast('PO dihapus'); } },

                selectProd(p) { const exist = this.cart.find(x => x.id === p.id); if (exist) { exist.qty++; } else { this.cart.push({ ...p, qty: 1, priceType: 'ecer', price: p.priceEcer, priceEcer: p.priceEcer, priceGrosir: p.priceGrosir }); } },
                cartTotal() { return this.cart.reduce((s, i) => s + i.price * i.qty, 0); },
                async checkout() { if (!this.cart.length) return; const tx = { date: new Date().toISOString(), customerName: this.txCustomer, payType: this.txType, items: this.cart.map(i => ({ name: i.name, qty: i.qty, price: i.price })), total: this.cartTotal() }; await fetch('/api/transactions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(tx) }); for (const i of this.cart) { const p = this.products.find(x => x.id === i.id); if (p) await fetch('/api/products/' + p.id + '/stock', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ stock: p.stock - i.qty }) }); } if (this.txType === 'debt' && this.txCustomer) { let c = this.customers.find(x => x.name.toLowerCase() === this.txCustomer.toLowerCase()); if (!c) { const res = await fetch('/api/customers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: this.txCustomer, phone: '', address: '', debt: tx.total }) }); } else { await fetch('/api/customers/' + c.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: c.name, phone: c.phone, address: c.address, debt: (c.debt || 0) + tx.total }) }); } } await this.loadFromAPI(); this.cart = []; this.txCustomer = ''; this.txType = 'cash'; this.showToast('Transaksi berhasil!'); },

                getTodayTx() { const t = new Date().toDateString(); return this.transactions.filter(x => new Date(x.date).toDateString() === t).length; },
                getTotalSales() { return this.transactions.reduce((s, t) => s + t.total, 0); },
                getTotalPurchases() { return this.purchases.reduce((s, p) => s + p.total, 0); },
                getTotalPiutang() { return this.customers.reduce((s, c) => s + (c.debt || 0), 0); },
                getTotalHutang() { return this.suppliers.reduce((s, s2) => s + (s2.debt || 0), 0); },

                calcInput(b) { if (b === 'C') { this.calcDisplay = ''; } else if (b === '=') { try { this.calcDisplay = String(eval(this.calcDisplay.replace('Ã—', '*').replace('Ã·', '/'))); } catch { this.calcDisplay = 'Error'; } } else { this.calcDisplay += b; } },

                exportData() { const d = { products: this.products, customers: this.customers, suppliers: this.suppliers, transactions: this.transactions, purchases: this.purchases, ledgerEntries: this.ledgerEntries, pin: this.pin }; const blob = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'backup_maju_bersama_' + new Date().toISOString().split('T')[0] + '.json'; a.click(); this.showToast('Backup berhasil'); },
                importData(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); this.products = d.products || []; this.customers = d.customers || []; this.suppliers = d.suppliers || []; this.transactions = d.transactions || []; this.purchases = d.purchases || []; this.ledgerEntries = d.ledgerEntries || []; if (d.pin) this.pin = d.pin; this.save(); this.showToast('Restore berhasil'); } catch { this.showToast('File tidak valid', 'error'); } }; r.readAsText(f); },
                async resetAll() { if (confirm('Hapus SEMUA data?')) { await fetch('/api/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ products: [], customers: [], suppliers: [], transactions: [], purchases: [], ledgerEntries: [], pin: '2103' }) }); location.reload(); } },

                // LEDGER FUNCTIONS
                openPayModal(type, entity) { this.payModalData = { type, entity, name: entity.name, debt: entity.debt, amount: entity.debt, note: '' }; this.showPayModal = true; },
                async processPayment() { const { type, entity, amount, note } = this.payModalData; if (!amount || amount <= 0) { this.showToast('Jumlah harus > 0', 'error'); return; } const payAmount = Math.min(Number(amount), entity.debt); const newDebt = Math.max(0, entity.debt - payAmount); const endpoint = type === 'customer' ? '/api/customers/' : '/api/suppliers/'; await fetch(endpoint + entity.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: entity.name, phone: entity.phone, address: entity.address, debt: newDebt }) }); await fetch('/api/ledger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: new Date().toISOString(), type: 'bayar', entityType: type, entityId: entity.id, entityName: entity.name, amount: payAmount, note: note || 'Pembayaran' }) }); await this.loadFromAPI(); this.showPayModal = false; this.showToast('Pembayaran Rp ' + this.fmt(payAmount) + ' berhasil'); },
                editDebtManual(type, entity) { this.editDebtData = { type, entity, name: entity.name, currentDebt: entity.debt, newDebt: entity.debt, note: '' }; this.showEditDebt = true; },
                async saveEditDebt() { const { type, entity, currentDebt, newDebt, note } = this.editDebtData; const diff = Number(newDebt) - currentDebt; if (diff === 0) { this.showEditDebt = false; return; } const endpoint = type === 'customer' ? '/api/customers/' : '/api/suppliers/'; await fetch(endpoint + entity.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: entity.name, phone: entity.phone, address: entity.address, debt: Number(newDebt) }) }); await fetch('/api/ledger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: new Date().toISOString(), type: diff > 0 ? (type === 'customer' ? 'piutang' : 'hutang') : 'bayar', entityType: type, entityId: entity.id, entityName: entity.name, amount: Math.abs(diff), note: note || 'Edit manual saldo' }) }); await this.loadFromAPI(); this.showEditDebt = false; this.showToast('Saldo diperbarui'); },
                viewLedgerHistory(type, id) { this.ledgerTab = 'riwayat'; },
                async saveLedgerEntry() { const { type, entityType, entityId, amount, note, date } = this.ledgerForm; if (!entityId || !amount) { this.showToast('Lengkapi data', 'error'); return; } const entity = entityType === 'customer' ? this.customers.find(c => c.id == entityId) : this.suppliers.find(s => s.id == entityId); if (!entity) { this.showToast('Entity tidak ditemukan', 'error'); return; } const amt = Number(amount); const endpoint = entityType === 'customer' ? '/api/customers/' : '/api/suppliers/'; let newDebt = entity.debt; if (type === 'bayar') { newDebt = Math.max(0, entity.debt - amt); } else { newDebt = entity.debt + amt; } await fetch(endpoint + entity.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: entity.name, phone: entity.phone, address: entity.address, debt: newDebt }) }); if (this.editingLedger) { await fetch('/api/ledger/' + this.editingLedger.id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: date || new Date().toISOString(), type, entityType, entityId, entityName: entity.name, amount: amt, note }) }); } else { await fetch('/api/ledger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: date || new Date().toISOString(), type, entityType, entityId, entityName: entity.name, amount: amt, note }) }); } await this.loadFromAPI(); this.showAddLedger = false; this.editingLedger = null; this.showToast('Entri disimpan'); },
                editLedgerEntry(l) { this.editingLedger = l; this.ledgerForm = { type: l.type, entityType: l.entityType, entityId: l.entityId, amount: l.amount, note: l.note, date: l.date ? l.date.split('T')[0] : '' }; this.showAddLedger = true; },
                async delLedgerEntry(id) { if (confirm('Hapus entri?')) { await fetch('/api/ledger/' + id, { method: 'DELETE' }); await this.loadFromAPI(); this.showToast('Entri dihapus'); } }
            };
        }
    </script>
</body>

</html>